// ======================
// PRISMA CONFIG
// ======================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================
// ENUMS
// ======================

enum UserRole {
  ADMIN
  PRO
  NORMAL
}

enum RoundStatus {
  DRAFT
  PENDING
  OPEN
  CLOSED
  SCORED
  CANCELLED
}

enum TicketStatus {
  PENDING
  WON
  LOST
}

enum RankingType {
  GLOBAL
  PRO
  BOLAO
}

enum RankingStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum SubscriptionPlan {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum WalletTransactionType {
  CREDIT
  DEBIT
}

// ======================
// ENUMS â€” PAGAMENTO
// ======================

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  PIX
  CARD
}

enum PaymentProvider {
  MERCADO_PAGO
}

// ======================
// USER
// ======================
model User {
  id               String   @id @default(uuid())
  name             String
  email            String   @unique
  password         String
  role             UserRole @default(NORMAL)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  nickname         String?  @unique
  cpf              String?  @unique
  profileImage     String?
  bio              String?
  phone            String?

  tickets          Ticket[]
  rankings         RankingParticipant[]
  auditLogs        AuditLog[]
  scoreHistory     UserScoreHistory[]
  rankingSnapshots RankingSnapshot[]

  createdBolao     Ranking[] @relation("BolaoCreator")

  subscription     Subscription?
  wallet           Wallet?
  roundBenefits    RoundBenefit[]
  bolaoInvites     BolaoInvite[]
  payments         Payment[]

  @@map("users")
}

// ======================
// ROUND
// ======================
model Round {
  id               String      @id @default(uuid())
  number           Int         @unique
  status           RoundStatus @default(DRAFT)
  openAt           DateTime?
  closeAt          DateTime?
  result           String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  tickets          Ticket[]
  rankings         RankingRound[]
  scoreHistory     UserScoreHistory[]
  rankingSnapshots RankingSnapshot[]
  roundBenefits    RoundBenefit[]

  @@map("rounds")
}

// ======================
// TICKET
// ======================
model Ticket {
  id          String       @id @default(uuid())
  userId      String
  roundId     String
  prediction  String
  status      TicketStatus @default(PENDING)
  scoreRound  Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  round       Round @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([userId, roundId])
  @@index([userId])
  @@index([roundId])
  @@map("tickets")
}

// ======================
// USER SCORE HISTORY
// ======================
model UserScoreHistory {
  id          String   @id @default(uuid())
  userId      String
  roundId     String
  scoreRound  Int
  scoreTotal  Int
  createdAt   DateTime @default(now())

  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  round       Round @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([userId, roundId])
  @@index([userId])
  @@index([roundId])
  @@map("user_score_history")
}

// ======================
// RANKING
// ======================
model Ranking {
  id                  String        @id
  name                String        @unique
  description         String?
  type                RankingType
  status              RankingStatus @default(DRAFT)

  startDate           DateTime?
  endDate             DateTime?

  maxParticipants     Int?
  currentParticipants Int           @default(0)
  durationDays        Int?

  createdByUserId     String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  participants        RankingParticipant[]
  rounds              RankingRound[]
  invites             BolaoInvite[]

  createdBy User? @relation("BolaoCreator", fields: [createdByUserId], references: [id])

  @@map("rankings")
}

// ======================
// RANKING PARTICIPANT
// ======================
model RankingParticipant {
  id           String   @id @default(uuid())
  rankingId    String
  userId       String
  score        Int      @default(0)
  scoreInitial Int      @default(0)
  position     Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ranking      Ranking @relation(fields: [rankingId], references: [id], onDelete: Cascade)
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([rankingId, userId])
  @@index([rankingId])
  @@index([userId])
  @@map("ranking_participants")
}

// ======================
// RANKING ROUND
// ======================
model RankingRound {
  id        String   @id @default(uuid())
  rankingId String
  roundId   String
  createdAt DateTime @default(now())

  ranking   Ranking @relation(fields: [rankingId], references: [id], onDelete: Cascade)
  round     Round   @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([rankingId, roundId])
  @@index([rankingId])
  @@index([roundId])
  @@map("ranking_rounds")
}

// ======================
// AUDIT LOG
// ======================
model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  user      User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// ======================
// RANKING SNAPSHOT
// ======================
model RankingSnapshot {
  id           String   @id @default(uuid())
  roundId      String
  userId       String

  scoreTotal   Int
  scoreRound   Int
  position     Int

  snapshotType String
  periodRef    String?

  createdAt    DateTime @default(now())

  round        Round @relation(fields: [roundId], references: [id], onDelete: Cascade)
  user         User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roundId, userId])
  @@index([roundId])
  @@index([userId])
  @@index([roundId, scoreTotal])
  @@map("ranking_snapshots")
}

// ======================
// SUBSCRIPTION
// ======================
model Subscription {
  id        String             @id @default(uuid())
  userId    String             @unique
  
  plan      SubscriptionPlan
  status    SubscriptionStatus 

  startAt   DateTime
  endAt     DateTime?

   // ðŸ”— vÃ­nculo externo (anti lock-in)
  provider               PaymentProvider?
  externalSubscriptionId String?
  externalCustomerId     String?

  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("subscriptions")
}

// ======================
// WALLET
// ======================
model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  ledger    WalletLedger[]

  @@map("wallets")
}

// ======================
// WALLET LEDGER
// ======================
model WalletLedger {
  id          String                  @id @default(uuid())
  walletId    String
  type        WalletTransactionType
  amount      Int
  description String?

  createdAt   DateTime @default(now())

  wallet      Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@map("wallet_ledger")
}

// ======================
// ROUND BENEFITS (FREE)
// ======================
model RoundBenefit {
  id               String   @id @default(uuid())
  userId           String
  roundId          String

  freeDoubles      Int      @default(0)
  freeSuperDoubles Int      @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  round            Round @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([userId, roundId])
  @@index([roundId])
  @@map("round_benefits")
}

// ======================
// BOLAO INVITE
// ======================
model BolaoInvite {
  id              String   @id @default(uuid())
  rankingId       String
  code            String   @unique

  maxUses         Int?
  usedCount       Int      @default(0)

  expiresAt       DateTime?
  isActive        Boolean  @default(true)

  createdByUserId String
  createdAt       DateTime @default(now())

  ranking         Ranking @relation(fields: [rankingId], references: [id], onDelete: Cascade)
  createdBy       User    @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@index([rankingId])
  @@index([code])
  @@map("bolao_invites")
}

// ======================
// PAYMENT
// ======================
model Payment {
  id                String          @id @default(uuid())

  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider          PaymentProvider
  method            PaymentMethod
  status            PaymentStatus   @default(PENDING)

  amountCents       Int
  coinsAmount       Int

  externalPaymentId String?         @unique
  externalReference String?         @unique

  isCredited        Boolean         @default(false)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([userId])
  @@index([status])
  @@map("payments")
}

// ======================
// PAYMENT WEBHOOK EVENT
// ======================
model PaymentWebhookEvent {
  id              String           @id @default(uuid())
  provider        PaymentProvider
  externalEventId String
  payload         Json
  receivedAt      DateTime         @default(now())

  @@unique([provider, externalEventId])
  @@map("payment_webhook_events")
}
